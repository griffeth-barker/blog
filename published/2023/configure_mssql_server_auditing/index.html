<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="If you are a system administrator who works with SQL Server, you know how important it is to audit your SQL Server instances and databases."><meta property="og:title" content="Configure Microsoft SQL Server Auditing"><meta property="og:description" content="If you are a system administrator who works with SQL Server, you know how important it is to audit your SQL Server instances and databases."><meta property="og:type" content="website"><meta property="og:image" content="https://blog.griff.systems/icon.png"><meta property="og:url" content="https://blog.griff.systems/published/2023/configure_mssql_server_auditing/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Configure Microsoft SQL Server Auditing"><meta name=twitter:description content="If you are a system administrator who works with SQL Server, you know how important it is to audit your SQL Server instances and databases."><meta name=twitter:image content="https://blog.griff.systems/icon.png"><title>Configure Microsoft SQL Server Auditing</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://blog.griff.systems//icon.png><link href=https://blog.griff.systems/styles.80333fa2099c0bee674efa435fde378c.min.css rel=stylesheet><link href=https://blog.griff.systems/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://blog.griff.systems/js/darkmode.c869d3a61240a800a16e2c2547d7ba0e.min.js></script>
<script src=https://blog.griff.systems/js/util.00639692264b21bc3ee219733d38a8be.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://blog.griff.systems/js/popover.aa9bc99c7c38d3ae9538f218f1416adb.min.js></script>
<script defer src=https://blog.griff.systems/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://blog.griff.systems/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://blog.griff.systems/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://blog.griff.systems/",fetchData=Promise.all([fetch("https://blog.griff.systems/indices/linkIndex.936f25950107e272fe15dc2273f0a64f.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://blog.griff.systems/indices/contentIndex.24e2162f9a7cd523612005e1b963445a.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://blog.griff.systems",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://blog.griff.systems",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()});function a(n){const e=n.target,t=e.className.split(" "),s=t.includes("broken"),o=t.includes("internal-link");plausible("Link Click",{props:{href:e.href,broken:s,internal:o,graph:!1}})}const r=document.querySelectorAll("a");for(link of r)link.className.includes("root-title")&&link.addEventListener("click",a,{once:!0})},init=()=>{addCopyButtons(),addTitleToCodeBlocks()}</script><script type=module>
    import { attachSPARouting } from "https:\/\/blog.griff.systems\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script><script defer data-domain=blog.griff.systems src=https://plausible.io/js/script.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://blog.griff.systems/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://blog.griff.systems/>blog.griff.systems</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Configure Microsoft SQL Server Auditing</h1><p class=meta>Last updated
Oct 28, 2023</p><ul class=tags><li><a href=https://blog.griff.systems/tags/mssql/>Mssql</a></li><li><a href=https://blog.griff.systems/tags/auditing/>Auditing</a></li><li><a href=https://blog.griff.systems/tags/powershell/>Powershell</a></li><li><a href=https://blog.griff.systems/tags/configuration/>Configuration</a></li><li><a href=https://blog.griff.systems/tags/security/>Security</a></li><li><a href=https://blog.griff.systems/tags/monitoring/>Monitoring</a></li></ul><p>If you are a system administrator who works with SQL Server, you know how important it is to audit your SQL Server instances and databases. Auditing allows you to track and record the activities that occur on your SQL Server environment, such as who accessed what data, when, and how. This can help you improve the security and compliance of your data, as well as troubleshoot and investigate any issues or incidents that may happen.</p><p>However, you also know how challenging it can be to set up and manage SQL Server auditing, especially if you have to deal with multiple servers and databases. Thatâ€™s why using PowerShell scripts can be a great solution for SQL Server auditing!</p><p>This blog post includes a script from my public GitHub repository that you can use to aid in the configuration of SQL server auditing in your environment.</p><a href=#the-script><h1 id=the-script><span class=hanchor arialabel=Anchor></span>The Script</h1></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=cm>&lt;#
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.SYNOPSIS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  This script creates MSSQL server audit objects in order to write audit logs to the Windows Security Log.
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.DESCRIPTION</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  This script utilizes the SqlServer PowerShell module to pass Transact-SQL statements to the target SQL server 
</span></span></span><span class=line><span class=cl><span class=cm>  instance, which creates the following SQL server objects:
</span></span></span><span class=line><span class=cl><span class=cm>    - Server Audit object on the master
</span></span></span><span class=line><span class=cl><span class=cm>    - Server Audit Specification object on the master
</span></span></span><span class=line><span class=cl><span class=cm>    - Database Audit Specification object on individual database(s)
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.PARAMETER</span><span class=cm> &lt;Parameter_Name&gt;
</span></span></span><span class=line><span class=cl><span class=cm>  None
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.INPUTS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  None
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.OUTPUTS</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  None
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.NOTES</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Updated by:     Barker, Griffeth (barkergriffeth@gmail.com)
</span></span></span><span class=line><span class=cl><span class=cm>  Change Date:    2023-03-28
</span></span></span><span class=line><span class=cl><span class=cm>  Purpose/Change: Initial development
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  This script requires that the server have Microsoft SQL Server and the SqlServer PowerShell module installed.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  This script is intended to be run via Group Policy Object against Microsoft SQL servers. 
</span></span></span><span class=line><span class=cl><span class=cm></span><span class=sd>.EXAMPLE</span><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  None
</span></span></span><span class=line><span class=cl><span class=cm>#&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Timestamp function for logging</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nb>Get-TimeStamp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s2>&#34;{0:MM/dd/yy} {0:HH:mm:ss}&#34;</span> <span class=o>-f</span> <span class=p>(</span><span class=nb>Get-Date</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>###############################################################################################################################</span>
</span></span><span class=line><span class=cl><span class=c># SCRIPT SETUP                                                                                                                #</span>
</span></span><span class=line><span class=cl><span class=c>###############################################################################################################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Setting up...&#34;</span> 
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Checking for existence of C:\temp ...&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$WorkingDir</span> <span class=p>=</span> <span class=s2>&#34;C:\temp&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=nv>$WorkingDir</span><span class=p>){</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Validated working directory.&#34;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Could not find C:\temp - creating it now...&#34;</span> 
</span></span><span class=line><span class=cl><span class=nb>New-Item</span> <span class=n>-Path</span> <span class=s2>&#34;C:\&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;temp&#34;</span> <span class=n>-ItemType</span> <span class=s2>&#34;directory&#34;</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Created C:\temp - proceeding.&#34;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$FileDate</span> <span class=p>=</span> <span class=nb>Get-Date</span> <span class=n>-Format</span> <span class=s1>&#39;yyyyMMdd-HHmm&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>Start-Transcript</span> <span class=n>-Path</span> <span class=s2>&#34;C:\temp\configure_sql_auditing_$FileDate.log&#34;</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>###############################################################################################################################</span>
</span></span><span class=line><span class=cl><span class=c># TRANSACT-SQL VIA SQLSERVER POWERSHELL MODULE                                                                                #</span>
</span></span><span class=line><span class=cl><span class=c>###############################################################################################################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get a list of the databases on the server. This is used to create the Database Audit Specification on each database.</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Getting list of databases to configure...&#34;</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$DbsToAudit</span> <span class=p>=</span> <span class=p>@((</span><span class=nb>Get-SqlDatabase</span> <span class=n>-ServerInstance</span> <span class=p>$(</span><span class=nv>$env:COMPUTERNAME</span><span class=p>)</span> <span class=n>-ErrorAction</span> <span class=n>Stop</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=n>Name</span> <span class=o>-ne</span> <span class=s1>&#39;tempdb&#39;</span><span class=p>}).</span><span class=n>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Got list of databases.&#34;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>catch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Failed to get list of databases! This could be due to the Powershell module not loading properly,&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] invalid permissions, or a variety of other reasons. The script will now exit.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>Stop-Transcript</span>
</span></span><span class=line><span class=cl>  <span class=n>Exit</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the Server Audit object using Transact-SQL passed via SqlServer PowerShell Module</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Creating the Server Audit Object [your_audit_name]...&#34;</span> 
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$SvrAuditObj</span> <span class=p>=</span> <span class=sh>@&#34;
</span></span></span><span class=line><span class=cl><span class=sh>USE master ;
</span></span></span><span class=line><span class=cl><span class=sh>GO
</span></span></span><span class=line><span class=cl><span class=sh>
</span></span></span><span class=line><span class=cl><span class=sh>CREATE SERVER AUDIT [your_audit_name]
</span></span></span><span class=line><span class=cl><span class=sh>TO APPLICATION_LOG ;
</span></span></span><span class=line><span class=cl><span class=sh>GO
</span></span></span><span class=line><span class=cl><span class=sh>
</span></span></span><span class=line><span class=cl><span class=sh>ALTER SERVER AUDIT [your_audit_name]
</span></span></span><span class=line><span class=cl><span class=sh>WITH (STATE = ON) ;
</span></span></span><span class=line><span class=cl><span class=sh>&#34;@</span>
</span></span><span class=line><span class=cl>  <span class=nb>Invoke-Sqlcmd</span> <span class=n>-ServerInstance</span> <span class=p>$(</span><span class=nv>$env:COMPUTERNAME</span><span class=p>)</span> <span class=n>-Query</span> <span class=nv>$SvrAuditObj</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Successfully created the Server Audit Object [your_audit_name].&#34;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>catch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Failed to create the Server Audit Object [your_audit_name]!&#34;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the Server Audit Specification object using Transact-SQL passed via SqlServer PowerShell Module</span>
</span></span><span class=line><span class=cl><span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Creating the Server Audit Specification Object [your_audit_name_spec]...&#34;</span> 
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>$SvrAuditSpecObj</span> <span class=p>=</span> <span class=sh>@&#34;
</span></span></span><span class=line><span class=cl><span class=sh>CREATE SERVER AUDIT SPECIFICATION [your_audit_name_spec]
</span></span></span><span class=line><span class=cl><span class=sh>FOR SERVER AUDIT [your_audit_name]
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( FAILED_LOGIN_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( APPLICATION_ROLE_CHANGE_PASSWORD_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( AUDIT_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( BACKUP_RESTORE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_OBJECT_OWNERSHIP_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_OBJECT_PERMISSION_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_OPERATION_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_OWNERSHIP_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_PERMISSION_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_PRINCIPAL_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_PRINCIPAL_IMPERSONATION_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( DATABASE_ROLE_MEMBER_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( FAILED_DATABASE_AUTHENTICATION_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( FAILED_LOGIN_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SCHEMA_OBJECT_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SCHEMA_OBJECT_OWNERSHIP_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SCHEMA_OBJECT_PERMISSION_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SERVER_OBJECT_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SERVER_OBJECT_OWNERSHIP_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SERVER_OBJECT_PERMISSION_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SERVER_OPERATION_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SERVER_ROLE_MEMBER_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( SERVER_STATE_CHANGE_GROUP ),
</span></span></span><span class=line><span class=cl><span class=sh>	ADD ( STATEMENT_ROLLBACK_GROUP ) ;
</span></span></span><span class=line><span class=cl><span class=sh>GO
</span></span></span><span class=line><span class=cl><span class=sh>
</span></span></span><span class=line><span class=cl><span class=sh>ALTER SERVER AUDIT SPECIFICATION [your_audit_name_spec]
</span></span></span><span class=line><span class=cl><span class=sh>WITH (STATE = ON) ;
</span></span></span><span class=line><span class=cl><span class=sh>&#34;@</span>
</span></span><span class=line><span class=cl>  <span class=nb>Invoke-Sqlcmd</span> <span class=n>-ServerInstance</span> <span class=p>$(</span><span class=nv>$env:COMPUTERNAME</span><span class=p>)</span> <span class=n>-Query</span> <span class=nv>$SvrAuditSpecObj</span> <span class=n>-ErrorAction</span> <span class=n>Stop</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Successfully created the Server Audit Specification Object [your_audit_name_spec].&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>catch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] Failed to create the Server Audit Specification Object [your_audit_name_spec]!&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the Database Audit Specification objects on each database using Transact-SQL passed via SqlServer PowerShell Module</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$DbToAudit</span> <span class=k>in</span> <span class=nv>$DbsToAudit</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] $DbToAudit - Creating the Database Audit Specification Object [your_audit_spec_name]...&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$DbAuditSpecObj</span> <span class=p>=</span> <span class=sh>@&#34;
</span></span></span><span class=line><span class=cl><span class=sh>USE $DbToAudit ;
</span></span></span><span class=line><span class=cl><span class=sh>GO
</span></span></span><span class=line><span class=cl><span class=sh>
</span></span></span><span class=line><span class=cl><span class=sh>CREATE DATABASE AUDIT SPECIFICATION [your_audit_spec_name]
</span></span></span><span class=line><span class=cl><span class=sh>FOR SERVER AUDIT [your_audit_name]
</span></span></span><span class=line><span class=cl><span class=sh>WITH (STATE = ON);
</span></span></span><span class=line><span class=cl><span class=sh>GO
</span></span></span><span class=line><span class=cl><span class=sh>&#34;@</span>
</span></span><span class=line><span class=cl>    <span class=nb>Invoke-Sqlcmd</span> <span class=n>-ServerInstance</span> <span class=p>$(</span><span class=nv>$env:COMPUTERNAME</span><span class=p>)</span> <span class=n>-Query</span> <span class=nv>$DbAuditSpecObj</span> <span class=n>-ErrorAction</span> <span class=n>Stop</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] $DbToAudit - Successfully created the Database Audit Specification Object [your_audit_spec_name].&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>catch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-Host</span> <span class=s2>&#34;[</span><span class=p>$(</span><span class=nb>Get-Timestamp</span><span class=p>)</span><span class=s2>] $DbToAudit - Failed to create the Database Audit Specification Object [your_audit_spec_name]!&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>###############################################################################################################################</span>
</span></span><span class=line><span class=cl><span class=c># SCRIPT CLEANUP                                                                                                              #</span>
</span></span><span class=line><span class=cl><span class=c>###############################################################################################################################</span>
</span></span><span class=line><span class=cl><span class=nb>Stop-Transcript</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>$SvrAuditObj</code> and <code>$SvrAuditSpecObj</code> can be customized to audit different actions on the database servers based on your environment and your needs. There is additional information on what you can audit in the <strong>Additional Resources</strong> section at the end of this post.</p><a href=#get-the-script><h1 id=get-the-script><span class=hanchor arialabel=Anchor></span>Get the Script</h1></a><p>You can copy/paste the above script into a file and save it as a .ps1, or if you&rsquo;d like you can download the script from my public GitHub repository to your user profile&rsquo;s Downloads folder using this command at a PowerShell terminal:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-PowerShell data-lang=PowerShell><span class=line><span class=cl><span class=nb>Invoke-WebRequest</span> <span class=n>-Uri</span> <span class=s2>&#34;https://raw.githubusercontent.com/griffeth-barker/public/main/powershell/configure_mssql_server_auditing.ps1&#34;</span> <span class=n>-OutFile</span> <span class=s2>&#34;</span><span class=p>$(</span><span class=nv>$env:USERPROFILE</span><span class=p>)</span><span class=s2>\Downloads\configure_mssql_server_auditing.ps1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>As always, you should fully understand any command or script before running it in your environment.</p><a href=#deployment><h1 id=deployment><span class=hanchor arialabel=Anchor></span>Deployment</h1></a><p>There are various ways this script can be utilized. The script can be loaded into Systems Center Configuration Manager (SCCM) and run against individual servers or collections of servers from there. Alternatively, the script can be copied directly to a server and run locally. You can even place the script in your domain&rsquo;s NETLOGON share or another location accessible by your servers and then configure a Group Policy Object to have servers call the script each time they boot.</p><p>One other great thing about configuring SQL server auditing is that the events will be written to the Windows Event Log, which can then easily be forwarded into your SIEM of choice for monitoring and alerting.</p><p>Auditing your databases is an important part of your systems monitoring and security; PowerShell is a powerful scripting language that can help automate this configuration. I hope you enjoyed this blog post and gained some useful knowledge about configuring SQL server auditing using Windows PowerShell!</p><a href=#additional-resources><h1 id=additional-resources><span class=hanchor arialabel=Anchor></span>Additional Resources</h1></a><ul><li><a href="https://learn.microsoft.com/en-us/sql/relational-databases/security/auditing/create-a-server-audit-and-server-audit-specification?view=sql-server-ver16" rel=noopener>Create Server Audit & Server Audit Specification - SQL Server | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/en-us/sql/relational-databases/security/auditing/create-a-server-audit-and-database-audit-specification?view=sql-server-ver16" rel=noopener>Create a server audit & database audit specification - SQL Server | Microsoft Learn</a></li><li><a href=https://learn.microsoft.com/en-us/training/paths/get-started-querying-with-transact-sql/ rel=noopener>Get Started Querying with Transact-SQL - Training | Microsoft Learn</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/drafts/toc_by_year/ data-ctx="Configure Microsoft SQL Server Auditing" data-src=/drafts/toc_by_year class=internal-link>Table of Contents</a></li><li><a href=/toc/ data-ctx="Configure Microsoft SQL Server Auditing" data-src=/toc class=internal-link>Table of Contents</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://blog.griff.systems/js/graph.6579af7b10c818dbd2ca038702db0224.js></script></div></div><div id=contact_buttons><footer><p>Made by Barker, Griffeth using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://blog.griff.systems/>Home</a></li><li><a href=https://mastodon.social/@kalipike>Follow me on Mastodon</a></li><li><a href=https://matrix.to/#/@kalipike:matrix>Chat with me on Matrix</a></li></ul></footer></div></div></body></html>